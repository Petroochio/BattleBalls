<!doctype html>
<html>
    <head>
        <meta name="viewport" content="initial-scale=1, maximum-scale=1">
        <title>Socket.IO chat</title>
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { font: 13px Helvetica, Arial; background: #000;}
            form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
            form input { border: 0; padding: 10px; width: 90%; margin-right: .5%; }
            form button { width: 8%; background: rgb(130, 224, 255); border: none; padding: 10px; user-select: none; -webkit-user-select: none;}
            #boomButton {user-select: none;}
            #dashButton {user-select: none;}
            #buttons { width: 200px; margin: 0 auto; user-select: none; -webkit-user-select: none;}
        </style>
        <script src="/socket.io/socket.io.js"></script>
        <script src="//code.jquery.com/jquery-2.1.3.min.js"></script>
        <script>
            window.onload = function(){
                // create new instance of socket.io
                var num = Math.floor(Math.random()*10);
                var name ='user'+num;
                var id = -1;

                var red = Math.floor(Math.random() * 105 +150);
                var green = Math.floor(Math.random() * 105 +150);
                var blue = Math.floor(Math.random() * 105 +150);
                var col = 'rgb('+red+','+green+','+blue+')';
                //setting client's own properties (MIGHT NOT BE THE BEST PRACTICE);
                var socket = io.connect( window.location.origin, {query: 'user='+name});

                var connectData = { id: id, color: col };

                socket.emit('player join', connectData);

                socket.on('player connect', function(data){
                    if(data.id !== -1) {
                        id = data.id;
                    }

                });

                var boomButton = document.querySelector("#boomButton");
                var boomCTX;
                if (boomButton.getContext) boomCTX = boomButton.getContext("2d");
                boomButton.addEventListener("touchstart", function(e){
                    var data = { id: id };
                    socket.emit('charge start', data);
                    redraw(boomButton, "BOOM",boomCTX);
                }, false);

                boomButton.addEventListener("touchend", function(e){
                    var data = { id: id };
                    socket.emit('charge end', data);
                    draw(boomButton, "BOOM",boomCTX);
                }, false);
                draw(boomButton, "BOOM",boomCTX);
                
                var dashButton = document.querySelector("#dashButton");
                var dashCTX;
                if (dashButton.getContext) dashCTX = dashButton.getContext("2d");
                dashButton.addEventListener("touchstart", function(e){
                    //hello peter
                    redraw(dashButton, "DASH",dashCTX);
                }, false);
                
                dashButton.addEventListener("touchend", function(e){
                    //hello peter
                    draw(dashButton, "DASH",dashCTX);
                }, false);
                draw(dashButton, "DASH",dashCTX);

                if (window.DeviceOrientationEvent) {
                    window.addEventListener('deviceorientation', function(e) {
                        // gamma is the left-to-right tilt in degrees, where right is positive
                        var xTilt = e.gamma;
                        // beta is the front-to-back tilt in degrees, where front is positive
                        var yTilt = e.beta;
                        // alpha is the compass direction the device is facing in degrees
                        var rot = e.alpha

                        var data = { id: id, xAcc : xTilt, yAcc : yTilt };
                        socket.emit('phone tilt', data);
                    }, false);
                }
                
            };
            function draw(canvas, butt, ctx) {
                ctx.save();
                ctx.clearRect(0,0,canvas.width,canvas.height);
                ctx.translate(canvas.width,canvas.height/64);
                ctx.rotate(Math.PI/2);
                switch(butt){
                    case "BOOM":
                        ctx.strokeStyle = "red";
                        ctx.fillStyle = "red";
                        ctx.shadowColor = "red";
                        break;
                    case "DASH":
                        ctx.strokeStyle = "blue";
                        ctx.fillStyle = "blue";
                        ctx.shadowColor = "blue";
                        break;
                }
                ctx.lineWidth = 5;
                ctx.shadowBlur = 10;
                ctx.beginPath();
                ctx.arc(canvas.width/2,canvas.height/2,canvas.width/2-10,0,Math.PI*2,false);
                ctx.closePath();
                ctx.stroke();

                ctx.font = 'bold 16px Monospace';
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText(butt,canvas.width/2,canvas.height/2);
                ctx.restore();
            };

            function redraw(canvas, butt, ctx) {
                ctx.save();
                ctx.clearRect(0,0,canvas.width,canvas.height);
                ctx.translate(canvas.width,canvas.height/64);
                ctx.rotate(Math.PI/2);
                switch(butt){
                    case "BOOM":
                        ctx.strokeStyle = "red";
                        ctx.fillStyle = "red";
                        break;
                    case "DASH":
                        ctx.strokeStyle = "blue";
                        ctx.fillStyle = "blue";
                        break;
                }
                ctx.lineWidth = 5;
                ctx.beginPath();
                ctx.arc(canvas.width/2,canvas.height/2,canvas.width/2-50,0,Math.PI*2,false);
                ctx.closePath();
                ctx.stroke();

                ctx.font = 'bold 16px Monospace';
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText(butt,canvas.width/2,canvas.height/2);
                ctx.restore();
            };
        </script>
    </head>
    <body>
        <div id="buttons">
            <canvas id="boomButton"width="200px"height="200px"></canvas>
            <canvas id="dashButton"width="200px"height="200px"></canvas>
        </div>
    </body>
</html>
